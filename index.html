<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Toâ€‘Do â€” Firebase Auth + Firestore</title>
  <style>
    :root {
      --bg: #0b1020;         /* deep navy */
      --panel: #121a33;      /* card */
      --muted: #7d8db5;      /* muted text */
      --text: #e8eeff;       /* primary text */
      --brand: #8aa1ff;      /* accent */
      --ok: #5bd6a0;         /* success */
      --warn: #ff9b6b;       /* warn */
      --danger: #ff6b88;     /* danger */
      --ring: 0 0 0 3px rgba(138,161,255,.25);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text); background: radial-gradient(1000px 600px at 10% -10%, #18244a 0%, transparent 60%), var(--bg);
      display: grid; place-items: start center; padding: 32px 16px;
    }
    .app { width: 100%; max-width: 760px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border: 1px solid rgba(255,255,255,.08); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,.35); overflow: hidden; }
    header { padding: 20px 20px 12px; display: flex; gap: 12px; align-items: center; border-bottom: 1px solid rgba(255,255,255,.08); }
    .logo { width: 36px; height: 36px; border-radius: 10px; display: grid; place-items: center; background: linear-gradient(135deg, #8aa1ff, #5bd6a0); color: #0a0f1e; font-weight: 800; }
    h1 { margin: 0; font-size: 18px; letter-spacing: .3px; }
    .muted { color: var(--muted); }

    .controls { padding: 16px 20px; display: grid; gap: 12px; background: rgba(0,0,0,.15); border-bottom: 1px solid rgba(255,255,255,.08); }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .input {
      flex: 1; min-width: 220px; display: flex; background: var(--panel); border: 1px solid rgba(255,255,255,.1); border-radius: 12px; overflow: hidden;
    }
    .input input { flex: 1; padding: 12px 12px; background: transparent; border: 0; color: var(--text); outline: none; }
    .input input::placeholder { color: #9db0e6; opacity: .65; }
    .btn { appearance: none; border: 1px solid rgba(255,255,255,.16); background: #18244a; color: var(--text); padding: 10px 12px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: .15s transform ease, .15s background ease, .15s border-color ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.brand { background: linear-gradient(135deg, #7d90ff, #5bd6a0); color: #0b1020; border-color: transparent; }
    .btn.ghost { background: transparent; }

    .filters { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip { padding: 8px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.05); cursor: pointer; font-weight: 600; }
    .chip.active { border-color: var(--brand); box-shadow: var(--ring); }

    ul.list { list-style: none; margin: 0; padding: 8px 8px 8px 8px; }
    .item { display: grid; grid-template-columns: 28px 1fr auto; align-items: center; gap: 10px; padding: 10px 12px; margin: 8px 4px; border-radius: 12px; background: rgba(11,16,32,.5); border: 1px solid rgba(255,255,255,.08); }
    .item[draggable="true"] { user-select: none; }
    .item.dragging { opacity: .6; outline: 2px dashed var(--brand); }

    .check { width: 18px; height: 18px; border-radius: 4px; border: 2px solid #6f86e8; display: grid; place-items: center; cursor: pointer; }
    .check.done { background: linear-gradient(135deg, #7d90ff, #5bd6a0); border-color: transparent; }
    .title { padding: 6px 8px; border-radius: 8px; }
    .title.done { color: #9fb0e1; text-decoration: line-through; }
    .title[contenteditable="true"] { outline: none; box-shadow: var(--ring); background: rgba(255,255,255,.06); }

    .actions { display: flex; gap: 6px; }
    .icon { width: 34px; height: 34px; border-radius: 10px; display: grid; place-items: center; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); cursor: pointer; }
    .icon:hover { background: rgba(255,255,255,.08); }
    .icon.danger { border-color: rgba(255,107,136,.4); }

    .footer { display: flex; justify-content: space-between; align-items: center; gap: 12px; padding: 12px 20px 16px; border-top: 1px solid rgba(255,255,255,.08); background: rgba(0,0,0,.12); }
    .small { font-size: 13px; color: var(--muted); }

    .spacer { flex: 1; }
    .auth { margin-left: auto; display: flex; align-items: center; gap: 10px; }
    .avatar { width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(255,255,255,.25); object-fit: cover; display: none; }
    .userName { font-size: 13px; color: var(--muted); display: none; }

    @media (max-width: 520px) { .actions { gap: 4px } .icon { width: 32px; height: 32px } }
  </style>
</head>
<body>
  <main class="app">
    <header>
      <div class="logo">âœ“</div>
      <h1 style="font-size:18px">Toâ€‘Do</h1>
      <div class="auth">
        <img id="avatar" class="avatar" alt="avatar" />
        <span id="who" class="userName"></span>
        <button id="signInBtn" class="btn">Sign in with Google</button>
        <button id="signOutBtn" class="btn ghost" style="display:none">Sign out</button>
      </div>
    </header>

    <section class="controls">
      <div class="row">
        <div class="input"><input id="newTodo" placeholder="Add a task and press Enterâ€¦" /></div>
        <button id="addBtn" class="btn brand">Add</button>
        <button id="clearCompletedBtn" class="btn">Clear completed</button>
      </div>
      <div class="row">
        <div class="input"><input id="search" type="search" placeholder="Searchâ€¦ (Ctrl/âŒ˜+K)" /></div>
        <button class="chip active" data-filter="all">All</button>
        <button class="chip" data-filter="active">Active</button>
        <button class="chip" data-filter="completed">Completed</button>
      </div>
    </section>

    <ul id="list" class="list"></ul>

    <div class="footer">
      <div><span id="count">0</span> task(s)</div>
      <div>
        <button id="exportBtn" class="btn">Export</button>
        <button id="importBtn" class="btn">Import</button>
        <input id="fileInput" type="file" accept="application/json" hidden />
      </div>
    </div>
  </main>

  <template id="itemTemplate">
    <li class="item" draggable="true">
      <button class="check"></button>
      <div class="title" contenteditable="false"></div>
      <div class="actions">
        <button data-action="edit">âœŽ</button>
        <button data-action="delete">ðŸ—‘</button>
      </div>
    </li>
  </template>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDsCyo78yufb2XDVw9q2PkBdBmpdMiDeJs",
      authDomain: "todohtml-92100.firebaseapp.com.firebaseapp.com",
      projectId: "todohtml-92100",
      storageBucket: "todohtml-92100.firebasestorage.app.appspot.com",
      messagingSenderId: "505722759256",
      appId: "1:505722759256:web:ddf265dcd4a5828551422d"
    };

    const appFB = initializeApp(firebaseConfig);
    const db = getFirestore(appFB);
    const auth = getAuth(appFB);
    const provider = new GoogleAuthProvider();

    let items = []; let filter = 'all'; let user = null; let unsubTodos = null;

    const els = {
      list: document.getElementById('list'),
      tmpl: document.getElementById('itemTemplate'),
      input: document.getElementById('newTodo'),
      addBtn: document.getElementById('addBtn'),
      clearCompletedBtn: document.getElementById('clearCompletedBtn'),
      chips: Array.from(document.querySelectorAll('.chip')),
      search: document.getElementById('search'),
      count: document.getElementById('count'),
      exportBtn: document.getElementById('exportBtn'),
      importBtn: document.getElementById('importBtn'),
      fileInput: document.getElementById('fileInput'),
      signInBtn: document.getElementById('signInBtn'),
      signOutBtn: document.getElementById('signOutBtn'),
      who: document.getElementById('who'),
      avatar: document.getElementById('avatar')
    };

    function attachTodosListener(){
      if(unsubTodos) unsubTodos();
      if(!user){ items=[]; render(); return; }
      const q = query(collection(db, `users/${user.uid}/todos`), orderBy('order'), orderBy('created'));
      unsubTodos = onSnapshot(q, snap=>{
        items = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
        render();
      });
    }

    async function add(title){
      title=(title||'').trim(); if(!title||!user) return;
      const maxOrder=items.reduce((m,i)=>Math.max(m,i.order||0),0);
      await addDoc(collection(db,`users/${user.uid}/todos`),{title,done:false,order:maxOrder+1,created:Date.now()});
      els.input.value='';
    }
    async function remove(id){ if(user) await deleteDoc(doc(db,`users/${user.uid}/todos`,id)); }
    async function toggle(id){ const it=items.find(i=>i.id===id); if(it&&user) await updateDoc(doc(db,`users/${user.uid}/todos`,id),{done:!it.done}); }
    async function rename(id,title){ const it=items.find(i=>i.id===id); if(it&&user) await updateDoc(doc(db,`users/${user.uid}/todos`,id),{title:title.trim()||it.title}); }
    async function clearCompleted(){ if(!user) return; const batch=writeBatch(db); items.filter(i=>i.done).forEach(i=>batch.delete(doc(db,`users/${user.uid}/todos`,i.id))); await batch.commit(); }
    async function persistOrder(){ if(!user) return; const nodes=Array.from(els.list.querySelectorAll('.item')); const batch=writeBatch(db); nodes.forEach((n,idx)=>batch.update(doc(db,`users/${user.uid}/todos`,n.dataset.id),{order:idx+1})); await batch.commit(); }

    function setFilter(f){ filter=f; els.chips.forEach(c=>{const on=c.dataset.filter===f;c.classList.toggle('active',on);}); render(); }
    function matchesFilter(i){ if(filter==='active') return !i.done; if(filter==='completed') return i.done; return true; }
    function matchesSearch(i){ const q=els.search.value.trim().toLowerCase(); if(!q) return true; return (i.title||'').toLowerCase().includes(q); }
    function render(){ els.list.innerHTML=''; const visible=items.slice().sort((a,b)=>(a.order||0)-(b.order||0)).filter(matchesFilter).filter(matchesSearch); for(const item of visible){ const node=els.tmpl.content.firstElementChild.cloneNode(true); node.dataset.id=item.id; const check=node.querySelector('.check'); const title=node.querySelector('.title'); if(item.done){check.classList.add('done');title.classList.add('done');} title.textContent=item.title; check.addEventListener('click',()=>toggle(item.id)); const startEdit=()=>{title.setAttribute('contenteditable','true');title.focus();placeCaretEnd(title);}; const finishEdit=()=>{title.removeAttribute('contenteditable');rename(item.id,title.textContent||'');}; node.querySelector('[data-action="edit"]').addEventListener('click',startEdit); title.addEventListener('dblclick',startEdit); title.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();finishEdit();} else if(e.key==='Escape'){title.textContent=item.title;title.blur();title.removeAttribute('contenteditable');}}); title.addEventListener('blur',finishEdit); node.querySelector('[data-action="delete"]').addEventListener('click',()=>remove(item.id)); node.addEventListener('dragstart',e=>{node.classList.add('dragging');e.dataTransfer.effectAllowed='move';}); node.addEventListener('dragend',()=>node.classList.remove('dragging')); els.list.appendChild(node);} els.count.textContent=items.filter(i=>!i.done).length; }
    function placeCaretEnd(el){ const r=document.createRange();r.selectNodeContents(el);r.collapse(false);const s=window.getSelection();s.removeAllRanges();s.addRange(r); }

    els.list.addEventListener('dragover',e=>{e.preventDefault();const after=getDragAfterElement(els.list,e.clientY);const dragging=els.list.querySelector('.dragging');if(!dragging)return;if(after==null){els.list.appendChild(dragging);}else{els.list.insertBefore(dragging,after);}});
    els.list.addEventListener('drop',()=>persistOrder());
    function getDragAfterElement(container,y){const els2=[...container.querySelectorAll('.item:not(.dragging)')];return els2.reduce((closest,child)=>{const box=child.getBoundingClientRect();const offset=y-box.top-box.height/2;if(offset<0&&offset>closest.offset){return{offset,element:child};}else return closest;},{offset:Number.NEGATIVE_INFINITY}).element;}

    els.addBtn.addEventListener('click',()=>add(els.input.value));
    els.input.addEventListener('keydown',e=>{if(e.key==='Enter'){add(els.input.value);}});
    els.clearCompletedBtn.addEventListener('click',clearCompleted);
    els.search.addEventListener('input',render);
    els.chips.forEach(ch=>ch.addEventListener('click',()=>setFilter(ch.dataset.filter)));

    els.exportBtn.addEventListener('click',async()=>{if(!user)return;const snap=await getDocs(query(collection(db,`users/${user.uid}/todos`)));const data=snap.docs.map(d=>({id:d.id,...d.data()}));const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='todos.json';a.click();URL.revokeObjectURL(a.href);});
    els.importBtn.addEventListener('click',()=>els.fileInput.click());
    els.fileInput.addEventListener('change',async e=>{if(!user)return;const f=e.target.files[0];if(!f)return;const text=await f.text();try{const data=JSON.parse(text);if(Array.isArray(data)){const batch=writeBatch(db);data.forEach((raw,idx)=>{const id=raw.id||Date.now()+""+idx;const ref=doc(db,`users/${user.uid}/todos`,id);batch.set(ref,{title:raw.title||'',done:!!raw.done,order:raw.order||idx+1,created:raw.created||Date.now()},{merge:true});});await batch.commit();}}catch{alert('Invalid file');} e.target.value='';});

    els.signInBtn.addEventListener('click',async()=>{try{await signInWithPopup(auth,provider);}catch(e){console.error(e);}});
    els.signOutBtn.addEventListener('click',()=>signOut(auth));

    onAuthStateChanged(auth,u=>{user=u||null;if(u){els.who.textContent=u.displayName||u.email;els.who.style.display='inline';if(u.photoURL){els.avatar.src=u.photoURL;els.avatar.style.display='inline-block';}els.signInBtn.style.display='none';els.signOutBtn.style.display='inline-block';attachTodosListener();}else{els.who.textContent='';els.who.style.display='none';els.avatar.style.display='none';els.signInBtn.style.display='inline-block';els.signOutBtn.style.display='none';items=[];render();if(unsubTodos)unsubTodos();}});

    setFilter('all');
  </script>
</body>
</html>
